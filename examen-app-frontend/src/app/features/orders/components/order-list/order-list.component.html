<div class="order-list-container">
  <header class="header">
    <div class="header-title">
      <h1>Gestión de Órdenes</h1>
      <span class="badge-sql">
        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <ellipse cx="12" cy="5" rx="9" ry="3"></ellipse>
          <path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"></path>
          <path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"></path>
        </svg>
        MySQL + JOINs
      </span>
    </div>
    <div class="header-actions">
      <select class="filter-select" [value]="statusFilter()" (change)="onStatusFilterChange($event)">
        @for (option of statusOptions; track option.value) {
          <option [value]="option.value">{{ option.label }}</option>
        }
      </select>
      <button class="btn btn-primary" (click)="openCreateModal()">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
        Nueva Orden
      </button>
    </div>
  </header>

  @if (isLoading()) {
    <div class="orders-list">
      @for (i of [1, 2, 3]; track i) {
        <div class="order-card skeleton-card">
          <div class="order-header">
            <div class="skeleton skeleton-title"></div>
            <div class="skeleton skeleton-badge"></div>
          </div>
          <div class="skeleton skeleton-text"></div>
          <div class="skeleton skeleton-text" style="width: 60%;"></div>
          <div class="order-products">
            <div class="skeleton skeleton-product"></div>
            <div class="skeleton skeleton-product"></div>
          </div>
        </div>
      }
    </div>
  }

  @if (hasError()) {
    <div class="state-container error">
      <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#A4193D" stroke-width="2">
        <circle cx="12" cy="12" r="10"></circle>
        <line x1="12" y1="8" x2="12" y2="12"></line>
        <line x1="12" y1="16" x2="12.01" y2="16"></line>
      </svg>
      <p>{{ errorMessage() }}</p>
      <button (click)="loadOrders()" class="btn btn-primary">Reintentar</button>
    </div>
  }

  @if (!isLoading() && !hasError() && orders().length === 0) {
    <div class="state-container">
      <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#999" stroke-width="2">
        <circle cx="9" cy="21" r="1"></circle>
        <circle cx="20" cy="21" r="1"></circle>
        <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
      </svg>
      <p>No hay órdenes</p>
      <p class="empty-hint">Crea tu primera orden con el botón de arriba</p>
    </div>
  }

  @if (!isLoading() && !hasError() && orders().length > 0) {
    <div class="orders-list">
      @for (order of orders(); track order.id) {
        <div class="order-card">
          <div class="order-header">
            <div class="order-info">
              <span class="order-number">{{ order.orderNumber }}</span>
              <span class="order-date">{{ order.createdAt | date:'dd/MM/yyyy HH:mm' }}</span>
            </div>
            <span class="badge" [class]="getStatusClass(order.status)">
              {{ getStatusLabel(order.status) }}
            </span>
          </div>

          <div class="order-customer">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
              <circle cx="12" cy="7" r="4"></circle>
            </svg>
            <span>{{ order.user?.firstName }} {{ order.user?.lastName }}</span>
            <span class="email">{{ order.user?.email }}</span>
          </div>

          <div class="order-address">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
              <circle cx="12" cy="10" r="3"></circle>
            </svg>
            <span>{{ order.shippingAddress }}</span>
          </div>

          <div class="order-products">
            <h4>Productos ({{ order.products?.length || 0 }})</h4>
            <div class="products-list">
              @for (product of order.products; track product.id) {
                <div class="product-item">
                  <span class="product-name">{{ product.name }}</span>
                  <span class="product-qty">x{{ product.OrderProduct?.quantity }}</span>
                  <span class="product-price">${{ product.OrderProduct?.subtotal | number:'1.2-2' }}</span>
                </div>
              }
            </div>
          </div>

          <div class="order-footer">
            <div class="order-total">
              <span>Total:</span>
              <strong>${{ order.totalAmount | number:'1.2-2' }}</strong>
            </div>
            <div class="order-actions">
              <button class="btn-icon" title="Ver detalles" (click)="openDetailModal(order)">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                  <circle cx="12" cy="12" r="3"></circle>
                </svg>
              </button>
              @if (order.status === 'pending') {
                <button class="btn-icon delete" title="Cancelar" (click)="cancelOrder(order)">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="15" y1="9" x2="9" y2="15"></line>
                    <line x1="9" y1="9" x2="15" y2="15"></line>
                  </svg>
                </button>
              }
            </div>
          </div>
        </div>
      }
    </div>

    @if (pagination() && pagination()!.totalPages > 1) {
      <div class="pagination">
        <button class="btn-page" [disabled]="currentPage() === 1" (click)="onPageChange(currentPage() - 1)">
          Anterior
        </button>
        <span class="page-info">Página {{ currentPage() }} de {{ totalPages() }}</span>
        <button class="btn-page" [disabled]="currentPage() === totalPages()" (click)="onPageChange(currentPage() + 1)">
          Siguiente
        </button>
      </div>
    }
  }

  @if (showModal()) {
    <div class="modal-overlay" (click)="closeModal()">
      <div class="modal modal-large" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>Nueva Orden</h2>
          <button class="btn-close" (click)="closeModal()">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>
        <div class="modal-body">
          <div class="modal-grid">
            <div class="products-section">
              <h3>Productos Disponibles</h3>
              <div class="products-grid">
                @for (product of products(); track product.id) {
                  <div class="product-card" [class.out-of-stock]="product.stock === 0">
                    <div class="product-info">
                      <span class="product-name">{{ product.name }}</span>
                      <span class="product-category">{{ product.category }}</span>
                      <span class="product-price">${{ product.price | number:'1.2-2' }}</span>
                      <span class="product-stock">Stock: {{ product.stock }}</span>
                    </div>
                    <button
                      class="btn btn-sm"
                      [disabled]="product.stock === 0"
                      (click)="addToCart(product)"
                    >
                      Agregar
                    </button>
                  </div>
                }
              </div>
            </div>

            <div class="cart-section">
              <h3>Carrito</h3>

              <div class="form-group">
                <label>Cliente *</label>
                <select
                  class="status-select"
                  [value]="selectedUserId()"
                  (change)="selectedUserId.set($any($event.target).value)"
                >
                  <option value="">Selecciona un usuario...</option>
                  @for (user of users(); track user.id) {
                    <option [value]="user.id">{{ user.firstName }} {{ user.lastName }} ({{ user.email }})</option>
                  }
                </select>
              </div>

              @if (cart().length === 0) {
                <p class="empty-cart">Agrega productos al carrito</p>
              } @else {
                <div class="cart-items">
                  @for (item of cart(); track item.product.id) {
                    <div class="cart-item">
                      <div class="cart-item-info">
                        <span class="item-name">{{ item.product.name }}</span>
                        <span class="item-price">${{ item.product.price | number:'1.2-2' }}</span>
                      </div>
                      <div class="cart-item-controls">
                        <input
                          type="number"
                          [value]="item.quantity"
                          min="1"
                          [max]="item.product.stock"
                          (change)="updateQuantity(item.product.id, +$any($event.target).value)"
                        />
                        <button class="btn-remove" (click)="removeFromCart(item.product.id)">
                          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                          </svg>
                        </button>
                      </div>
                      <span class="item-subtotal">${{ (item.product.price * item.quantity) | number:'1.2-2' }}</span>
                    </div>
                  }
                </div>
                <div class="cart-total">
                  <span>Total:</span>
                  <strong>${{ cartTotal() | number:'1.2-2' }}</strong>
                </div>
              }

              <div class="form-group">
                <label>Dirección de Envío *</label>
                <textarea
                  [value]="shippingAddress()"
                  (input)="shippingAddress.set($any($event.target).value)"
                  placeholder="Ingresa la dirección completa..."
                  rows="3"
                ></textarea>
              </div>

              <div class="form-group">
                <label>Notas (opcional)</label>
                <textarea
                  [value]="notes()"
                  (input)="notes.set($any($event.target).value)"
                  placeholder="Instrucciones especiales..."
                  rows="2"
                ></textarea>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" (click)="closeModal()" [disabled]="isSaving()">Cancelar</button>
          <button
            class="btn btn-primary"
            (click)="createOrder()"
            [disabled]="!selectedUserId() || cart().length === 0 || !shippingAddress().trim() || isSaving()"
          >
            @if (isSaving()) {
              <span class="btn-spinner"></span>
              Creando...
            } @else {
              Crear Orden (${{ cartTotal() | number:'1.2-2' }})
            }
          </button>
        </div>
      </div>
    </div>
  }

  @if (showDetailModal() && selectedOrder()) {
    <div class="modal-overlay" (click)="closeDetailModal()">
      <div class="modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>Orden {{ selectedOrder()?.orderNumber }}</h2>
          <button class="btn-close" (click)="closeDetailModal()">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>
        <div class="modal-body">
          <div class="detail-section">
            <h4>Cliente</h4>
            <p>{{ selectedOrder()?.user?.firstName }} {{ selectedOrder()?.user?.lastName }}</p>
            <p class="text-muted">{{ selectedOrder()?.user?.email }}</p>
          </div>

          <div class="detail-section">
            <h4>Dirección de Envío</h4>
            <p>{{ selectedOrder()?.shippingAddress }}</p>
          </div>

          @if (selectedOrder()?.notes) {
            <div class="detail-section">
              <h4>Notas</h4>
              <p>{{ selectedOrder()?.notes }}</p>
            </div>
          }

          <div class="detail-section">
            <h4>Productos</h4>
            <table class="detail-table">
              <thead>
                <tr>
                  <th>Producto</th>
                  <th>Precio</th>
                  <th>Cantidad</th>
                  <th>Subtotal</th>
                </tr>
              </thead>
              <tbody>
                @for (product of selectedOrder()?.products; track product.id) {
                  <tr>
                    <td>{{ product.name }}</td>
                    <td>${{ product.OrderProduct?.unitPrice | number:'1.2-2' }}</td>
                    <td>{{ product.OrderProduct?.quantity }}</td>
                    <td>${{ product.OrderProduct?.subtotal | number:'1.2-2' }}</td>
                  </tr>
                }
              </tbody>
              <tfoot>
                <tr>
                  <td colspan="3"><strong>Total</strong></td>
                  <td><strong>${{ selectedOrder()?.totalAmount | number:'1.2-2' }}</strong></td>
                </tr>
              </tfoot>
            </table>
          </div>

          <div class="detail-section">
            <h4>Estado</h4>
            <select
              class="status-select"
              [value]="selectedOrder()?.status"
              (change)="updateOrderStatus(selectedOrder()!, $any($event.target).value)"
            >
              <option value="pending">Pendiente</option>
              <option value="processing">Procesando</option>
              <option value="shipped">Enviado</option>
              <option value="delivered">Entregado</option>
              <option value="cancelled">Cancelado</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" (click)="closeDetailModal()">Cerrar</button>
        </div>
      </div>
    </div>
  }
</div>
