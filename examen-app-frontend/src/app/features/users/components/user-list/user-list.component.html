<div class="user-list-container">
  <header class="header">
    <h1>Gestión de Usuarios</h1>

    <div class="header-actions">
      <div class="search-bar">
        <input
          type="text"
          placeholder="Buscar por nombre o email..."
          [value]="searchTerm()"
          (input)="onSearch($event)"
          class="search-input"
        />
        <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="m21 21-4.3-4.3"></path>
        </svg>
      </div>

      <button class="btn btn-primary" (click)="openCreateModal()">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
        Nuevo Usuario
      </button>
    </div>
  </header>

  @if (isLoading()) {
    <div class="table-container">
      <table class="users-table">
        <thead>
          <tr>
            <th>Nombre</th>
            <th>Email</th>
            <th>Rol</th>
            <th>Estado</th>
            <th>Fecha de Registro</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          @for (i of [1, 2, 3, 4, 5]; track i) {
            <tr class="skeleton-row">
              <td class="user-name">
                <div class="skeleton skeleton-avatar"></div>
                <div class="skeleton skeleton-text" style="width: 140px;"></div>
              </td>
              <td><div class="skeleton skeleton-text" style="width: 180px;"></div></td>
              <td><div class="skeleton skeleton-badge"></div></td>
              <td><div class="skeleton skeleton-badge" style="width: 60px;"></div></td>
              <td><div class="skeleton skeleton-text" style="width: 90px;"></div></td>
              <td class="actions">
                <div class="skeleton skeleton-icon"></div>
                <div class="skeleton skeleton-icon"></div>
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  }

  @if (hasError()) {
    <div class="state-container error">
      <svg class="state-icon" xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#A4193D" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="10"></circle>
        <line x1="12" y1="8" x2="12" y2="12"></line>
        <line x1="12" y1="16" x2="12.01" y2="16"></line>
      </svg>
      <p>{{ errorMessage() }}</p>
      <button (click)="onRetry()" class="btn btn-primary">
        Reintentar
      </button>
    </div>
  }

  @if (isEmpty() && !isLoading()) {
    <div class="state-container empty">
      <svg class="state-icon" xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#999" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
        <circle cx="9" cy="7" r="4"></circle>
        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
      </svg>
      <p>No se encontraron usuarios</p>
      @if (searchTerm()) {
        <p class="empty-hint">Intenta con otros términos de búsqueda</p>
      }
    </div>
  }

  @if (!isLoading() && !hasError() && !isEmpty()) {
    <div class="table-container">
      <table class="users-table">
        <thead>
          <tr>
            <th>Nombre</th>
            <th>Email</th>
            <th>Rol</th>
            <th>Estado</th>
            <th>Fecha de Registro</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          @for (user of users(); track trackByUserId($index, user)) {
            <tr>
              <td class="user-name">
                <span class="avatar">{{ user.firstName[0] }}{{ user.lastName[0] }}</span>
                {{ user.firstName }} {{ user.lastName }}
              </td>
              <td>{{ user.email }}</td>
              <td>
                <span class="badge" [class.admin]="user.role === 'admin'" [class.user]="user.role === 'user'">
                  {{ user.role === 'admin' ? 'Administrador' : 'Usuario' }}
                </span>
              </td>
              <td>
                <span class="status" [class.active]="user.isActive" [class.inactive]="!user.isActive">
                  {{ user.isActive ? 'Activo' : 'Inactivo' }}
                </span>
              </td>
              <td>{{ user.createdAt | date:'dd/MM/yyyy' }}</td>
              <td class="actions">
                <button class="btn-icon" title="Editar" (click)="openEditModal(user)">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                  </svg>
                </button>
                <button class="btn-icon delete" title="Eliminar" (click)="deleteUser(user)">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    <line x1="10" y1="11" x2="10" y2="17"></line>
                    <line x1="14" y1="11" x2="14" y2="17"></line>
                  </svg>
                </button>
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>

    @if (pagination()) {
      <div class="pagination">
        <div class="pagination-info">
          Mostrando {{ (currentPage() - 1) * itemsPerPage() + 1 }} -
          {{ currentPage() * itemsPerPage() > pagination()!.total ? pagination()!.total : currentPage() * itemsPerPage() }}
          de {{ pagination()!.total }} usuarios
        </div>

        <div class="pagination-controls">
          <button
            class="btn-page"
            [disabled]="currentPage() === 1"
            (click)="onPrevious()"
          >
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="15 18 9 12 15 6"></polyline>
            </svg>
            Anterior
          </button>

          @for (page of pages(); track page) {
            <button
              class="btn-page"
              [class.active]="page === currentPage()"
              (click)="onPageChange(page)"
            >
              {{ page }}
            </button>
          }

          <button
            class="btn-page"
            [disabled]="currentPage() === totalPages()"
            (click)="onNext()"
          >
            Siguiente
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
          </button>
        </div>
      </div>
    }
  }

  @if (showModal()) {
    <div class="modal-overlay" (click)="closeModal()">
      <div class="modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>{{ editingUser() ? 'Editar Usuario' : 'Nuevo Usuario' }}</h2>
          <button class="btn-close" (click)="closeModal()">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>
        <div class="modal-body">
          <div class="form-row">
            <div class="form-group">
              <label>Nombre</label>
              <input
                type="text"
                [value]="formData().firstName"
                (input)="updateField('firstName', $event)"
                placeholder="Nombre"
              />
            </div>
            <div class="form-group">
              <label>Apellido</label>
              <input
                type="text"
                [value]="formData().lastName"
                (input)="updateField('lastName', $event)"
                placeholder="Apellido"
              />
            </div>
          </div>
          <div class="form-group">
            <label>Email</label>
            <input
              type="email"
              [value]="formData().email"
              (input)="updateField('email', $event)"
              placeholder="correo@ejemplo.com"
            />
          </div>
          <div class="form-group">
            <label>{{ editingUser() ? 'Nueva Contraseña (dejar vacío para mantener)' : 'Contraseña' }}</label>
            <input
              type="password"
              [value]="formData().password"
              (input)="updateField('password', $event)"
              placeholder="********"
            />
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Rol</label>
              <select [value]="formData().role" (change)="updateField('role', $event)">
                <option value="user">Usuario</option>
                <option value="admin">Administrador</option>
              </select>
            </div>
            <div class="form-group">
              <label>Estado</label>
              <div class="checkbox-group">
                <input
                  type="checkbox"
                  id="isActive"
                  [checked]="formData().isActive"
                  (change)="updateField('isActive', $event)"
                />
                <label for="isActive">Usuario activo</label>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" (click)="closeModal()" [disabled]="isSaving()">Cancelar</button>
          <button class="btn btn-primary" (click)="saveUser()" [disabled]="isSaving()">
            @if (isSaving()) {
              <span class="btn-spinner"></span>
              Guardando...
            } @else {
              {{ editingUser() ? 'Guardar' : 'Crear' }}
            }
          </button>
        </div>
      </div>
    </div>
  }
</div>
