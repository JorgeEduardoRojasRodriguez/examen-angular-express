<div class="task-list-container">
  <header class="header">
    <h1>Gestión de Tareas</h1>
    <div class="header-actions">
      <div class="search-bar">
        <input
          type="text"
          placeholder="Buscar por título..."
          [value]="searchTerm()"
          (input)="onSearch($event)"
          class="search-input"
        />
        <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="m21 21-4.3-4.3"></path>
        </svg>
      </div>

      <select class="filter-select" [value]="statusFilter()" (change)="onStatusFilterChange($event)">
        <option value="all">Todos los estados</option>
        <option value="pending">Pendientes</option>
        <option value="in_progress">En Progreso</option>
        <option value="completed">Completadas</option>
      </select>

      <select class="filter-select" [value]="priorityFilter()" (change)="onPriorityFilterChange($event)">
        <option value="all">Todas las prioridades</option>
        <option value="high">Alta</option>
        <option value="medium">Media</option>
        <option value="low">Baja</option>
      </select>

      <button class="btn btn-primary" (click)="openCreateModal()">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
        Nueva Tarea
      </button>
    </div>
  </header>

  @if (isLoading()) {
    <div class="tasks-grid">
      @for (i of [1, 2, 3, 4, 5, 6]; track i) {
        <div class="task-card skeleton-card">
          <div class="task-header">
            <div class="skeleton skeleton-badge"></div>
            <div class="skeleton skeleton-badge" style="width: 50px;"></div>
          </div>
          <div class="skeleton skeleton-title"></div>
          <div class="skeleton skeleton-text"></div>
          <div class="skeleton skeleton-text" style="width: 60%;"></div>
          <div class="skeleton skeleton-date"></div>
          <div class="task-actions">
            <div class="skeleton skeleton-icon"></div>
            <div class="skeleton skeleton-icon"></div>
          </div>
        </div>
      }
    </div>
  }

  @if (hasError()) {
    <div class="state-container error">
      <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#A4193D" stroke-width="2">
        <circle cx="12" cy="12" r="10"></circle>
        <line x1="12" y1="8" x2="12" y2="12"></line>
        <line x1="12" y1="16" x2="12.01" y2="16"></line>
      </svg>
      <p>{{ errorMessage() }}</p>
      <button (click)="loadTasks()" class="btn btn-primary">Reintentar</button>
    </div>
  }

  @if (!isLoading() && !hasError() && tasks().length === 0) {
    <div class="state-container">
      <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#999" stroke-width="2">
        <path d="M9 11l3 3L22 4"></path>
        <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
      </svg>
      <p>No hay tareas</p>
      @if (searchTerm() || statusFilter() !== 'all' || priorityFilter() !== 'all') {
        <p class="empty-hint">Intenta con otros filtros de búsqueda</p>
      }
    </div>
  }

  @if (!isLoading() && !hasError() && tasks().length > 0) {
    <div class="tasks-grid">
      @for (task of tasks(); track task.id) {
        <div class="task-card" [class]="'priority-' + task.priority">
          <div class="task-header">
            <span class="badge status" [class]="task.status">
              {{ getStatusLabel(task.status) }}
            </span>
            <span class="badge priority" [class]="task.priority">
              {{ getPriorityLabel(task.priority) }}
            </span>
          </div>
          <h3 class="task-title">{{ task.title }}</h3>
          <p class="task-description">{{ task.description }}</p>
          @if (task.dueDate) {
            <div class="task-date">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="16" y1="2" x2="16" y2="6"></line>
                <line x1="8" y1="2" x2="8" y2="6"></line>
                <line x1="3" y1="10" x2="21" y2="10"></line>
              </svg>
              {{ task.dueDate | date:'dd/MM/yyyy' }}
            </div>
          }
          <div class="task-actions">
            <button class="btn-icon" title="Editar" (click)="openEditModal(task)">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
              </svg>
            </button>
            <button class="btn-icon delete" title="Eliminar" (click)="deleteTask(task)">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
              </svg>
            </button>
          </div>
        </div>
      }
    </div>

    @if (pagination() && pagination()!.totalPages > 1) {
      <div class="pagination">
        <div class="pagination-info">
          Mostrando {{ (currentPage() - 1) * itemsPerPage() + 1 }} -
          {{ currentPage() * itemsPerPage() > pagination()!.total ? pagination()!.total : currentPage() * itemsPerPage() }}
          de {{ pagination()!.total }} tareas
        </div>

        <div class="pagination-controls">
          <button
            class="btn-page"
            [disabled]="currentPage() === 1"
            (click)="onPrevious()"
          >
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="15 18 9 12 15 6"></polyline>
            </svg>
            Anterior
          </button>

          @for (page of pages(); track page) {
            <button
              class="btn-page"
              [class.active]="page === currentPage()"
              (click)="onPageChange(page)"
            >
              {{ page }}
            </button>
          }

          <button
            class="btn-page"
            [disabled]="currentPage() === totalPages()"
            (click)="onNext()"
          >
            Siguiente
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
          </button>
        </div>
      </div>
    }
  }

  @if (showModal()) {
    <div class="modal-overlay" (click)="closeModal()">
      <div class="modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>{{ editingTask() ? 'Editar Tarea' : 'Nueva Tarea' }}</h2>
          <button class="btn-close" (click)="closeModal()">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>Título</label>
            <input
              type="text"
              [value]="formData().title"
              (input)="updateField('title', $event)"
              placeholder="Título de la tarea"
            />
          </div>
          <div class="form-group">
            <label>Descripción</label>
            <textarea
              [value]="formData().description"
              (input)="updateField('description', $event)"
              placeholder="Descripción de la tarea"
              rows="3"
            ></textarea>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Estado</label>
              <select [value]="formData().status" (change)="updateField('status', $event)">
                <option value="pending">Pendiente</option>
                <option value="in_progress">En Progreso</option>
                <option value="completed">Completada</option>
              </select>
            </div>
            <div class="form-group">
              <label>Prioridad</label>
              <select [value]="formData().priority" (change)="updateField('priority', $event)">
                <option value="low">Baja</option>
                <option value="medium">Media</option>
                <option value="high">Alta</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label>Fecha de vencimiento</label>
            <input
              type="date"
              [value]="formData().dueDate"
              (input)="updateField('dueDate', $event)"
            />
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" (click)="closeModal()" [disabled]="isSaving()">Cancelar</button>
          <button class="btn btn-primary" (click)="saveTask()" [disabled]="isSaving()">
            @if (isSaving()) {
              <span class="btn-spinner"></span>
              Guardando...
            } @else {
              {{ editingTask() ? 'Guardar' : 'Crear' }}
            }
          </button>
        </div>
      </div>
    </div>
  }
</div>
